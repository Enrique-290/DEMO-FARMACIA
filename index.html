<!DOCTYPE html>
<html lang='es'><head><meta charset='utf-8'/><meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>TPV Farmacia ‚Äî Demo</title>
<style>
:root{--pri:#0f766e;--b:#dbe5e3;--muted:#64748b}*{box-sizing:border-box}body{margin:0;font-family:system-ui;background:#f7faf9}
header{position:sticky;top:0;background:linear-gradient(180deg,#fff,#f1f5f4);border-bottom:1px solid #e5ecea}
.wrap{max-width:1100px;margin:auto;padding:16px}.logo{width:44px;height:44px;border-radius:12px;background:#0f766e;display:grid;place-items:center;color:#eafff9;font-weight:900}
nav{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}.navbtn{border:1px solid var(--b);background:#fff;border-radius:12px;padding:12px;text-align:left;cursor:pointer}
.view{display:none}.active{display:block}.card{background:#fff;border:1px solid var(--b);border-radius:12px;padding:12px}
.grid{display:grid;gap:10px}.cols-2{grid-template-columns:repeat(2,1fr)}@media(max-width:800px){.cols-2{grid-template-columns:1fr}}
table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid #eef3f2;font-size:14px;text-align:left}th{font-size:12px;color:var(--muted);text-transform:uppercase}
.btn{background:#0f766e;color:#fff;border:0;border-radius:10px;padding:9px 12px;cursor:pointer}.btn.ghost{background:#e8f4f3;color:#0a4e49}
input,select,textarea{border:1px solid var(--b);border-radius:10px;padding:9px;background:#fff;width:100%}.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.badge{background:#e8f4f3;color:#0a4e49;border:1px solid #cfe4e1;border-radius:999px;padding:6px 10px;font-size:12px}
</style></head>
<body>
<header><div class='wrap'>
  <div style='display:flex;gap:12px;align-items:center'><div class='logo'>RX</div><div><h1>TPV Farmacia</h1><div style='color:#64748b;font-size:13px'>Demo local</div></div>
  <div style='margin-left:auto;display:flex;gap:8px'><button class='btn' onclick="openIAWindow()">Consultar con IA</button><button class='btn ghost' onclick="goto('config')">Men√∫</button></div></div>
  <nav id='menu'></nav>
</div></header>
<main class='wrap'>
<section id='view-ventas' class='view active'>
  <div class='grid cols-2'>
    <div class='card'><h2>Ventas</h2>
      <div class='toolbar'><input id='buscar' placeholder='Escanea o busca SKU / nombre‚Ä¶' onkeydown="if(event.key==='Enter') buscarYAgregar()"/><button class='btn' onclick='buscarYAgregar()'>Agregar</button><span class='badge'>Folio: <span id='folio-num'>0001</span></span></div>
      <div id='sugerencias' class='card' style='display:none;max-height:180px;overflow:auto'></div>
      <table id='tabla-carrito'><thead><tr><th>SKU</th><th>Producto</th><th>Cant.</th><th>Precio</th><th>IVA</th><th>Importe</th><th></th></tr></thead><tbody></tbody></table>
      <div class='toolbar' style='justify-content:space-between'><div class='muted'>M√©todo: <select id='pago'><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></div>
      <div style='display:flex;gap:8px;align-items:center;flex-wrap:wrap'><input id='descuento' type='number' min='0' max='100' step='0.1' placeholder='Descuento % (opcional)' oninput='renderCarrito()' style='width:170px'/>
      <span class='badge' id='subtotal'>Subtotal: $0.00</span><span class='badge' id='impuestos'>Impuestos: $0.00</span><span class='badge' id='descuentoBadge' style='display:none'>Descuento: $0.00</span><span class='badge' id='total'>Total: $0.00</span>
      <button class='btn' onclick='cobrar()'>Cobrar</button></div></div>
    </div>
    <div class='card'><h3>Atajos</h3><div class='grid' style='grid-template-columns:repeat(3,1fr)' id='atajos'></div><p class='muted'>El stock se descuenta al cobrar. Ticket 58mm.</p></div>
  </div>
</section>
<section id='view-inventario' class='view'>
  <div class='card'><h2>Inventario</h2>
  <div class='grid cols-2'>
    <div class='card'><h3>Producto</h3><div class='grid'>
      <input id='inv-sku' placeholder='SKU*'/><input id='inv-nombre' placeholder='Nombre*'/><input id='inv-categoria' placeholder='Categor√≠a'/>
      <input id='inv-precioVenta' type='number' step='0.01' placeholder='Precio venta*'/>
      <label>IVA (opcional)<select id='inv-iva'><option value='' selected>‚Äî</option><option value='16'>16%</option><option value='8'>8%</option><option value='0'>0%</option></select></label>
      <input id='inv-stock' type='number' placeholder='Stock*'/><input id='inv-lote' placeholder='Lote'/><input id='inv-cad' type='date' placeholder='Caducidad'/>
      <input id='inv-index' type='hidden'/>
      <div class='toolbar'><button class='btn' onclick='guardarProducto()'>Guardar</button><button class='btn ghost' onclick='limpiarProducto()'>Limpiar</button></div>
    </div></div>
    <div class='card'><h3>Listado</h3><div class='toolbar'><input placeholder='Buscar‚Ä¶' oninput='filtrarInventario(this.value)'/><button class='btn ghost' onclick='exportarCSV()'>Exportar CSV</button></div>
      <table id='tabla-inv'><thead><tr><th>SKU</th><th>Producto</th><th>Stock</th><th>Precio</th><th>Lote</th><th>Caducidad</th><th></th></tr></thead><tbody></tbody></table>
    </div>
  </div></div>
</section>
<section id='view-consultorio' class='view'>
  <div class='card'><h2>Consultorio (demo)</h2>
    <div class='grid cols-2'>
      <div class='card'><h3>Nota cl√≠nica</h3><div class='grid'>
        <select id='nc-paciente'></select><input id='nc-motivo' placeholder='Motivo'/><textarea id='nc-dx' rows='2' placeholder='Diagn√≥stico'></textarea><textarea id='nc-tx' rows='2' placeholder='Tratamiento'></textarea>
        <div class='toolbar'><button class='btn' onclick='guardarNotaClinica()'>Guardar nota</button><button class='btn ghost' onclick='generarRecetaDesdeNota()'>Generar receta (demo)</button></div>
      </div>
      <div class='card' style='margin-top:8px'><h3>Archivos del paciente</h3><div class='toolbar'><input id='pac-files' type='file' multiple/><button class='btn' onclick='uploadPatientFiles()'>Subir archivos</button></div>
      <table id='tabla-archivos'><thead><tr><th>Nombre</th><th>Tipo</th><th>Tama√±o</th><th>Fecha</th><th></th></tr></thead><tbody></tbody></table></div>
      </div>
      <div class='card'><h3>Historial</h3><table id='tabla-notas'><thead><tr><th>Fecha</th><th>Paciente</th><th>Dx</th><th>Tx</th></tr></thead><tbody></tbody></table></div>
    </div>
  </div>
</section>
<section id='view-config' class='view'>
  <div class='card'><h2>Configuraci√≥n</h2>
  <div class='grid cols-2'>
    <div class='card'><h3>Negocio</h3><label>Nombre del negocio<br/><input id='negocio' placeholder='Farmacia Demo'/></label>
      <div class='toolbar'><button class='btn' onclick='guardarConfig()'>Guardar</button><span class='muted'>Se guarda en este dispositivo.</span></div></div>
    <div class='card'><h3>Ticket</h3><label>Mensaje al pie<br/><input id='pie' placeholder='Gracias por su compra üíä'/></label></div>
    <div class='card'><h3>Mantenimiento</h3><p class='muted'>Borra todos los datos locales para devolver equipos de prueba.</p><button class='btn ghost' onclick='limpiarDatosDemo()'>Borrar datos del dispositivo (demo)</button></div>
  </div></div>
</section>
</main>

<section id='view-ia' class='view' style='padding:16px;display:none'><div class='wrap'><div class='card'><h2>Consulta IA</h2>
<p class='muted'>Apoyo cl√≠nico (no sustituye juicio m√©dico).</p><textarea id='ia-q' rows='6' placeholder='Escribe tu consulta‚Ä¶'></textarea>
<div class='toolbar'><button class='btn' onclick='consultaIA()'>Consultar</button><button class='btn ghost' onclick='copyToNota()'>Copiar a Nota Cl√≠nica</button></div>
<div id='ia-respuesta' class='card' style='white-space:pre-wrap'></div></div></div></section>

<script>
const STORE_KEY='tpv_farma_data_v1';
const defaultData={inventario:[
 {sku:'PARA-500', nombre:'Paracetamol 500mg 10 tabs', precioVenta:45, iva:'', stock:120, lote:'L12345', cad:'2026-05-10'},
 {sku:'IBU-400', nombre:'Ibuprofeno 400mg 20 tabs', precioVenta:80, iva:'16', stock:85, lote:'I45678', cad:'2026-01-20'},
 {sku:'VITA-C1G', nombre:'Vitamina C 1g 100 tabs', precioVenta:150, iva:'', stock:40, lote:'V78901', cad:'2027-03-15'},
 {sku:'SUERO-500', nombre:'Suero oral 500ml', precioVenta:35, iva:'16', stock:100, lote:'S99001', cad:'2025-12-10'}
], pacientes:[{nombre:'Juan P√©rez'},{nombre:'Mar√≠a L√≥pez'},{nombre:'Carlos Ram√≠rez'}], ventas:[]};
let db = JSON.parse(localStorage.getItem(STORE_KEY)||'null')||defaultData;
function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(db)); }

const AREAS=[{id:'ventas',nombre:'Ventas'},{id:'inventario',nombre:'Inventario'},{id:'consultorio',nombre:'Consultorio'},{id:'config',nombre:'Configuraci√≥n'}];
const menu=document.getElementById('menu'); AREAS.forEach(a=>{const b=document.createElement('button'); b.className='navbtn'; b.innerHTML='<b>'+a.nombre+'</b><div style="color:#64748b">Abrir</div>'; b.onclick=()=>goto(a.id); menu.appendChild(b);});
function mostrar(id){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); const sec=document.getElementById('view-'+id); if(sec){ sec.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }}

let carrito=[]; function formatea(n){return '$'+(+n).toFixed(2)}
function sugerenciasHTML(list){ return list.map(p=>"<div style='padding:6px 8px;border-bottom:1px solid #eef3f2;cursor:pointer' onclick='agregarProductoPorSKU(\""+p.sku+"\")'><b>"+p.nombre+"</b><br><span style='color:#64748b'>"+p.sku+" ¬∑ $"+((+p.precioVenta)||0).toFixed(2)+" ¬∑ Stock: "+(p.stock||0)+"</span></div>").join(''); }
function buscarYAgregar(){ const q=(document.getElementById('buscar').value||'').trim().toLowerCase(); if(!q) return; const inv=db.inventario||[]; let list=inv.filter(p=>(p.sku||'').toLowerCase()===q); if(list.length===0){ list=inv.filter(p=>(p.nombre||'').toLowerCase().includes(q)); const sug=document.getElementById('sugerencias'); if(list.length>1){ sug.innerHTML=sugerenciasHTML(list.slice(0,20)); sug.style.display='block'; return; } } const p=list[0]; if(!p){ alert('No encontrado'); return;} document.getElementById('sugerencias').style.display='none'; agregarLinea(p); document.getElementById('buscar').value=''; }
function agregarProductoPorSKU(sku){ const p=(db.inventario||[]).find(x=>x.sku===sku); if(p){ document.getElementById('sugerencias').style.display='none'; agregarLinea(p);} }
function agregarLinea(p){ const precio=+(p.precioVenta||0); const ivaPctRaw = (p.iva==="" || p.iva===null || typeof p.iva==='undefined') ? null : +p.iva; const existe=carrito.find(i=>i.sku===p.sku); if(existe){ if((existe.cant+1)>(+p.stock||0)){ alert('Sin stock'); return;} existe.cant++; renderCarrito(); return; } carrito.push({sku:p.sku,nombre:p.nombre,cant:1,precio,ivaPct:ivaPctRaw,stock:+(p.stock||0)}); renderCarrito(); }
function cambiarCant(i,delta){ const it=carrito[i]; if(!it) return; const nueva=it.cant+delta; if(nueva<=0){ carrito.splice(i,1);} else if(nueva>it.stock){ alert('Stock insuficiente'); } else { it.cant=nueva; } renderCarrito(); }
function quitarItem(i){ carrito.splice(i,1); renderCarrito(); }
function renderCarrito(){ const tb=document.querySelector('#tabla-carrito tbody'); tb.innerHTML=''; let subtotal=0, impuestos=0; carrito.forEach((it,i)=>{ const base=it.cant*it.precio; const iva=(it.ivaPct==null?0:base*(it.ivaPct/100)); subtotal+=base; impuestos+=iva; const ivaTxt=(it.ivaPct==null?'‚Äî':(it.ivaPct||0)+'%'); const tr=document.createElement('tr'); tr.innerHTML='<td>'+it.sku+'</td><td>'+it.nombre+'</td><td><button class="btn ghost" onclick="cambiarCant('+i+',-1)">-</button> '+it.cant+' <button class="btn ghost" onclick="cambiarCant('+i+',1)">+</button></td><td>'+formatea(it.precio)+'</td><td>'+ivaTxt+'</td><td>'+formatea(base+iva)+'</td><td><button class="btn ghost" onclick="quitarItem('+i+')">Quitar</button></td>'; tb.appendChild(tr); }); const pctEl=document.getElementById('descuento'); const pct=(pctEl && pctEl.value!==''? Math.max(0,Math.min(100,+pctEl.value)):null); const preTotal=subtotal+impuestos; const descAmt=pct==null?0:(preTotal*(pct/100)); const total=preTotal-descAmt; document.getElementById('subtotal').textContent='Subtotal: '+formatea(subtotal); document.getElementById('impuestos').textContent='Impuestos: '+formatea(impuestos); const dbadge=document.getElementById('descuentoBadge'); if(pct==null||descAmt<=0){ dbadge.style.display='none'; } else { dbadge.style.display='inline-grid'; dbadge.textContent='Descuento ('+pct.toFixed(1)+'%): -'+formatea(descAmt); } document.getElementById('total').textContent='Total: '+formatea(total); }
function siguienteFolio(){ const f= +(localStorage.getItem('folio')||1); localStorage.setItem('folio', f+1); const s=String(f).padStart(4,'0'); const el=document.getElementById('folio-num'); if(el) el.textContent=s; return s; }
function cargarFolio(){ const f= +(localStorage.getItem('folio')||1); const s=String(f).padStart(4,'0'); const el=document.getElementById('folio-num'); if(el) el.textContent=s; }
function cobrar(){ if(carrito.length===0){ alert('Carrito vac√≠o'); return;} for(const it of carrito){ const prod=(db.inventario||[]).find(p=>p.sku===it.sku); if(!prod || (+prod.stock<it.cant)){ alert('Stock insuficiente de '+(it.nombre||it.sku)); return; } } let subtotal=0, impuestos=0; carrito.forEach(it=>{ const base=it.cant*it.precio; const iva=(it.ivaPct==null?0:base*(it.ivaPct/100)); subtotal+=base; impuestos+=iva; }); const pctEl=document.getElementById('descuento'); const pct=(pctEl && pctEl.value!==''? Math.max(0,Math.min(100,+pctEl.value)):null); const preTotal=subtotal+impuestos; const descAmt=pct==null?0:(preTotal*(pct/100)); const totalNum=preTotal-descAmt; carrito.forEach(it=>{ const prod=db.inventario.find(p=>p.sku===it.sku); prod.stock=(+prod.stock||0)-it.cant; }); save(); pintarInv(); db.ventas=db.ventas||[]; const folio=siguienteFolio(); const ticket={folio,fecha:new Date().toLocaleString(),pago:document.getElementById('pago').value,descuentoPct:pct,descuentoAmt:descAmt,subtotal,impuestos,total:'$'+totalNum.toFixed(2),items:carrito.map(i=>({sku:i.sku,nombre:i.nombre,cant:i.cant,precio:i.precio,iva:i.ivaPct}))}; db.ventas.push(ticket); save(); imprimirTicket(ticket); carrito=[]; renderCarrito(); alert('Cobro registrado'); }
function imprimirTicket(t){ const negocio=localStorage.getItem('negocio')||'Farma Demo'; const pie=localStorage.getItem('pieTicket')||'Gracias por su compra üíä'; const win=window.open('','ticket','width=380,height=600'); win.document.write('<html><head><title>Ticket '+t.folio+'</title><style>body{font-family:system-ui;padding:10px}h3{margin:0 0 6px 0}table{width:100%;font-size:12px;border-collapse:collapse}td{padding:4px 0;border-bottom:1px dashed #ccc}</style></head><body>'); win.document.write('<h3>'+negocio+'</h3><div>Folio: '+t.folio+' | '+t.fecha+'</div><hr><table>'); t.items.forEach(i=>{ const base=(i.cant*i.precio); const ivaLine=(i.iva==null?0:(base*(i.iva/100))); const imp=base+ivaLine; const ivaBadge=(i.iva==null?'':" <span style='color:#0a4e49'>(IVA "+i.iva+'%)</span>'); win.document.write('<tr><td>'+i.nombre+' x'+i.cant+ivaBadge+'</td><td style="text-align:right">$'+imp.toFixed(2)+'</td></tr>'); }); win.document.write('</table><hr>'); if(t.impuestos && t.impuestos>0){ win.document.write('<div style="text-align:right">Subtotal: $'+t.subtotal.toFixed(2)+'</div>'); win.document.write('<div style="text-align:right">IVA: $'+t.impuestos.toFixed(2)+'</div>'); } if(t.descuentoPct!=null && t.descuentoAmt>0){ win.document.write('<div style="text-align:right">Descuento ('+t.descuentoPct.toFixed(1)+'%): -$'+t.descuentoAmt.toFixed(2)+'</div>'); } win.document.write('<div style="text-align:right;font-weight:700">Total: '+t.total+'</div>'); if(t.impuestos && t.impuestos>0){ win.document.write('<p style="margin-top:6px;font-size:11px;text-align:center">*Precios ya incluyen impuestos (IVA 16%)*</p>'); } win.document.write('<p style="margin-top:10px;text-align:center">'+pie+'</p></body></html>'); win.document.close(); win.print(); }

function getInvForm(){ return { sku:document.getElementById('inv-sku').value.trim(), nombre:document.getElementById('inv-nombre').value.trim(), categoria:document.getElementById('inv-categoria').value.trim(), precioVenta:+(document.getElementById('inv-precioVenta').value||0), iva:(document.getElementById('inv-iva').value===''? '': document.getElementById('inv-iva').value), stock:+(document.getElementById('inv-stock').value||0), lote:document.getElementById('inv-lote').value.trim(), cad:document.getElementById('inv-cad').value }; }
function setInvForm(p){ document.getElementById('inv-sku').value=p.sku||''; document.getElementById('inv-nombre').value=p.nombre||''; document.getElementById('inv-categoria').value=p.categoria||''; document.getElementById('inv-precioVenta').value=p.precioVenta||''; document.getElementById('inv-iva').value=(p.iva===''?'':p.iva)||''; document.getElementById('inv-stock').value=p.stock||''; document.getElementById('inv-lote').value=p.lote||''; document.getElementById('inv-cad').value=p.cad||''; }
function limpiarProducto(){ setInvForm({}); document.getElementById('inv-index').value=''; }
function guardarProducto(){ const idx=(document.getElementById('inv-index').value||''); const p=getInvForm(); if(!p.sku||!p.nombre||!p.precioVenta){ alert('SKU, Nombre y Precio venta son obligatorios'); return; } if(idx===''){ db.inventario.push(p);} else { db.inventario[+idx]=p;} save(); limpiarProducto(); pintarInv(); }
function editarProducto(i){ document.getElementById('inv-index').value=i; setInvForm(db.inventario[i]); }
function eliminarProducto(i){ if(confirm('¬øEliminar producto?')){ db.inventario.splice(i,1); save(); pintarInv(); } }
function pintarInv(list){ list=list||db.inventario; const tb=document.querySelector('#tabla-inv tbody'); if(!tb) return; tb.innerHTML=''; list.forEach((p,i)=>{ const tr=document.createElement('tr'); tr.innerHTML='<td>'+p.sku+'</td><td>'+p.nombre+'</td><td>'+p.stock+'</td><td>$'+(+p.precioVenta).toFixed(2)+'</td><td>'+(p.lote||'')+'</td><td>'+(p.cad||'')+'</td><td><button class="btn ghost" onclick="editarProducto('+i+')">Editar</button> <button class="btn" onclick="eliminarProducto('+i+')">Eliminar</button></td>'; tb.appendChild(tr); }); }
function filtrarInventario(q){ const v=(q||'').toLowerCase(); pintarInv(db.inventario.filter(p=>Object.values(p).join(' ').toLowerCase().includes(v))); }
function exportarCSV(){ const rows=[['SKU','Nombre','Categor√≠a','PrecioVenta','IVA','Stock','Lote','Caducidad'],...db.inventario.map(p=>[p.sku,p.nombre,p.categoria||'',p.precioVenta,p.iva,p.stock,p.lote||'',p.cad||''])]; const csv=rows.map(r=>r.join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='inventario.csv'; a.click(); URL.revokeObjectURL(url); }

const notasClinicas=[];
function cargarPacientes(){ const sel=document.getElementById('nc-paciente'); if(!sel) return; sel.innerHTML=''; (db.pacientes||[]).forEach(p=>{ const o=document.createElement('option'); o.value=p.nombre; o.textContent=p.nombre; sel.appendChild(o); }); }
function guardarNotaClinica(){ const n={fecha:new Date().toISOString().slice(0,10), paciente:document.getElementById('nc-paciente').value, dx:document.getElementById('nc-dx').value||'‚Äî', tx:document.getElementById('nc-tx').value||'‚Äî'}; notasClinicas.push(n); pintarNotas(); alert('Nota cl√≠nica guardada (demo)'); }
function generarRecetaDesdeNota(){ const paciente=document.getElementById('nc-paciente').value; alert('Receta generada (demo) para '+paciente); }
function pintarNotas(){ const tb=document.querySelector('#tabla-notas tbody'); if(!tb) return; tb.innerHTML=''; notasClinicas.forEach(n=>{ const tr=document.createElement('tr'); tr.innerHTML='<td>'+n.fecha+'</td><td>'+n.paciente+'</td><td>'+n.dx+'</td><td>'+n.tx+'</td>'; tb.appendChild(tr); }); }

let filesDB=null;
function openFilesDB(){ return new Promise((resolve,reject)=>{ const req=indexedDB.open('tpv_farma_files',1); req.onupgradeneeded=e=>{ const db=e.target.result; if(!db.objectStoreNames.contains('files')){ const s=db.createObjectStore('files',{keyPath:'id',autoIncrement:true}); s.createIndex('paciente','paciente',{unique:false}); } }; req.onsuccess=()=>{filesDB=req.result; resolve(filesDB);} ; req.onerror=()=>reject(req.error); }); }
function addFileRecord(rec){ return new Promise((resolve,reject)=>{ const tx=filesDB.transaction('files','readwrite'); const s=tx.objectStore('files'); const r=s.add(rec); r.onsuccess=()=>resolve(r.result); r.onerror=()=>reject(r.error); }); }
function getFilesByPaciente(paciente){ return new Promise((resolve,reject)=>{ const tx=filesDB.transaction('files','readonly'); const s=tx.objectStore('files'); const idx=s.index('paciente'); const req=idx.openCursor(IDBKeyRange.only(paciente)); const out=[]; req.onsuccess=e=>{ const cur=e.target.result; if(cur){ out.push(cur.value); cur.continue(); } else resolve(out); }; req.onerror=()=>reject(req.error); }); }
async function uploadPatientFiles(){ try{ await openFilesDB(); const sel=document.getElementById('nc-paciente'); const paciente=sel?sel.value:''; if(!paciente){ alert('Selecciona un paciente'); return; } const inp=document.getElementById('pac-files'); const files=[...(inp?.files||[])]; if(!files.length){ alert('Elige uno o m√°s archivos'); return; } for(const f of files){ const buf=await f.arrayBuffer(); const blob=new Blob([buf],{type:f.type||'application/octet-stream'}); const rec={paciente,name:f.name,blob, size:f.size, type:f.type||'', date:new Date().toISOString()}; await addFileRecord(rec); } await renderArchivosForSelected(); alert('Archivos cargados'); } catch(e){ alert('No se pudieron guardar archivos'); } }
async function renderArchivosForSelected(){ try{ await openFilesDB(); const sel=document.getElementById('nc-paciente'); if(!sel) return; const paciente=sel.value||''; const list=paciente?await getFilesByPaciente(paciente):[]; const tb=document.querySelector('#tabla-archivos tbody'); if(!tb) return; tb.innerHTML=''; list.sort((a,b)=> b.date.localeCompare(a.date)); list.forEach(item=>{ const tr=document.createElement('tr'); const size=(item.size/1024).toFixed(1)+' KB'; const d=new Date(item.date).toLocaleString(); tr.innerHTML='<td>'+item.name+'</td><td>'+(item.type||'')+'</td><td>'+size+'</td><td>'+d+'</td><td><button class="btn ghost" onclick="downloadFile('+item.id+')">Descargar</button></td>'; tb.appendChild(tr); }); } catch(e){ /* noop */ } }
async function downloadFile(id){ await openFilesDB(); const tx=filesDB.transaction('files','readonly'); const s=tx.objectStore('files'); const r=s.get(id); r.onsuccess=()=>{ const rec=r.result; if(!rec) return; const url=URL.createObjectURL(rec.blob); const a=document.createElement('a'); a.href=url; a.download=rec.name; a.click(); URL.revokeObjectURL(url); }; }

function openIAWindow(){ const base=location.origin+location.pathname; window.open(base+'#'+'/ia','consulta-ia'); }
async function consultaIA(){ const q=(document.getElementById('ia-q').value||'').trim(); const out=document.getElementById('ia-respuesta'); if(!q){ alert('Escribe tu consulta'); return; } out.textContent='Consultando‚Ä¶ (demo)'; setTimeout(()=>{ out.textContent='Resumen: ejemplo cl√≠nico\nDiferenciales: ...\nSugerir estudios: ...\nRed flags: ...'; }, 600); }
function copyToNota(){ const r=document.getElementById('ia-respuesta').textContent||''; const dx=document.getElementById('nc-dx'); const tx=document.getElementById('nc-tx'); if(dx&&tx){ dx.value=(dx.value?dx.value+'\n':'')+'‚Äî Apoyo IA ‚Äî\n'+r.split('Sugerir estudios:')[0].trim(); tx.value=(tx.value?tx.value+'\n':'')+(r.match(/Sugerir estudios:(.*)/s)?.[1]?.trim()||''); alert('Copiado a Nota Cl√≠nica'); } else { alert('Abre Nota Cl√≠nica para pegar.'); } }

function guardarConfig(){ localStorage.setItem('negocio',document.getElementById('negocio').value); localStorage.setItem('pieTicket',document.getElementById('pie').value); alert('Configuraci√≥n guardada'); }
function cargarConfig(){ document.getElementById('negocio').value=localStorage.getItem('negocio')||''; document.getElementById('pie').value=localStorage.getItem('pieTicket')||'Gracias por su compra üíä'; }
async function limpiarDatosDemo(){ if(!confirm('Esto borrar√° inventario, ventas, config y archivos locales. ¬øContinuar?')) return; localStorage.removeItem(STORE_KEY); localStorage.removeItem('folio'); localStorage.removeItem('pieTicket'); localStorage.removeItem('negocio'); if(window.indexedDB){ await new Promise(res=>{ const req=indexedDB.deleteDatabase('tpv_farma_files'); req.onsuccess=req.onerror=req.onblocked=()=>res(); }); } alert('Datos borrados. Se recargar√°.'); location.reload(); }

function goto(id){ location.hash='#/'+id; }
function route(){ const id=(location.hash.replace('#/','')||'ventas'); document.getElementById('view-ia').style.display=(id==='ia')?'block':'none'; mostrar(id); }
window.addEventListener('hashchange',route);

function init(){ pintarInv(); cargarConfig(); cargarPacientes(); cargarFolio(); initAtajos(); route(); }
function pintarInv(list){ list=list||db.inventario; const tb=document.querySelector('#tabla-inv tbody'); if(!tb) return; tb.innerHTML=''; list.forEach((p,i)=>{ const tr=document.createElement('tr'); tr.innerHTML='<td>'+p.sku+'</td><td>'+p.nombre+'</td><td>'+p.stock+'</td><td>$'+(+p.precioVenta).toFixed(2)+'</td><td>'+(p.lote||'')+'</td><td>'+(p.cad||'')+'</td><td><button class="btn ghost" onclick="editarProducto('+i+')">Editar</button> <button class="btn" onclick="eliminarProducto('+i+')">Eliminar</button></td>'; tb.appendChild(tr); }); }
function initAtajos(){ const cont=document.getElementById('atajos'); if(!cont) return; cont.innerHTML=''; (db.inventario||[]).slice(0,9).forEach(p=>{ const b=document.createElement('button'); b.className='btn ghost'; b.textContent=(p.nombre||'').split(' ').slice(0,2).join(' '); b.title=p.nombre; b.onclick=()=>agregarLinea(p); cont.appendChild(b); }); }
function filtrarInventario(q){ const v=(q||'').toLowerCase(); pintarInv(db.inventario.filter(p=>Object.values(p).join(' ').toLowerCase().includes(v))); }

init();
</script>
</body></html>
