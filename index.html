<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>TPV Farmacia ‚Äî Demo con Exportaciones</title>
<style>
:root{--pri:#0f766e;--b:#dbe5e3;--muted:#64748b}
*{box-sizing:border-box}body{margin:0;font-family:system-ui;background:#f7faf9;color:#1f2937}
header{position:sticky;top:0;background:linear-gradient(180deg,#fff,#f1f5f4);border-bottom:1px solid #e5ecea}
.wrap{max-width:1200px;margin:auto;padding:16px}
.logo{width:44px;height:44px;border-radius:12px;background:#0f766e;display:grid;place-items:center;color:#eafff9;font-weight:900}
nav{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
.navbtn{border:1px solid var(--b);background:#fff;border-radius:12px;padding:12px;text-align:left;cursor:pointer}
.view{display:none}.active{display:block}
.card{background:#fff;border:1px solid var(--b);border-radius:12px;padding:12px}
.grid{display:grid;gap:10px}.cols-2{grid-template-columns:repeat(2,1fr)}@media(max-width:900px){.cols-2{grid-template-columns:1fr}}
table{width:100%;border-collapse:collapse}th,td{padding:10px;border-bottom:1px solid #eef3f2;font-size:14px;text-align:left}th{font-size:12px;color:var(--muted);text-transform:uppercase}
.btn{background:#0f766e;color:#fff;border:0;border-radius:10px;padding:9px 12px;cursor:pointer}.btn.ghost{background:#e8f4f3;color:#0a4e49}
input,select,textarea{border:1px solid var(--b);border-radius:10px;padding:9px;background:#fff;width:100%}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0}
.badge{background:#e8f4f3;color:#0a4e49;border:1px solid #cfe4e1;border-radius:999px;padding:6px 10px;font-size:12px}
.muted{color:#64748b}
header .right{margin-left:auto;display:flex;gap:8px}
</style>
</head>
<body>
<header>
  <div class="wrap" style="display:flex;gap:12px;align-items:center">
    <div class="logo">RX</div>
    <div><h1 style="margin:0">TPV Farmacia</h1><div class="muted" style="font-size:13px">Demo local ‚Äî con exportaciones</div></div>
    <div class="right">
      <button class="btn" onclick="openIAWindow()">Consultar con IA</button>
      <button class="btn ghost" onclick="goto('config')">Men√∫</button>
    </div>
  </div>
  <div class="wrap"><nav id="menu"></nav></div>
</header>

<main class="wrap">
  <!-- VENTAS -->
  <section id="view-ventas" class="view active">
    <div class="grid cols-2">
      <div class="card">
        <h2>Ventas</h2>
        <div class="toolbar">
          <input id="buscar" placeholder="Escanea o busca SKU / nombre‚Ä¶" onkeydown="if(event.key==='Enter') buscarYAgregar()"/>
          <button class="btn" onclick="buscarYAgregar()">Agregar</button>
          <span class="badge">Folio: <span id="folio-num">0001</span></span>
        </div>
        <div id="sugerencias" class="card" style="display:none;max-height:180px;overflow:auto"></div>
        <table id="tabla-carrito">
          <thead><tr><th>SKU</th><th>Producto</th><th>Cant.</th><th>Precio</th><th>IVA</th><th>Importe</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="toolbar" style="justify-content:space-between">
          <div class="muted">M√©todo: <select id="pago"><option>Efectivo</option><option>Tarjeta</option><option>Transferencia</option></select></div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="descuento" type="number" min="0" max="100" step="0.1" placeholder="Descuento % (opcional)" oninput="renderCarrito()" style="width:170px"/>
            <span class="badge" id="subtotal">Subtotal: $0.00</span>
            <span class="badge" id="impuestos">Impuestos: $0.00</span>
            <span class="badge" id="descuentoBadge" style="display:none">Descuento: $0.00</span>
            <span class="badge" id="total">Total: $0.00</span>
            <button class="btn" onclick="cobrar()">Cobrar</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Atajos</h3>
        <div class="grid" style="grid-template-columns:repeat(3,1fr)" id="atajos"></div>
        <p class="muted">Conecta a Inventario. El stock baja al cobrar. Ticket 58mm.</p>
      </div>
    </div>
  </section>

  <!-- INVENTARIO -->
  <section id="view-inventario" class="view">
    <div class="card">
      <h2>Inventario</h2>
      <div class="toolbar">
        <input placeholder="Buscar‚Ä¶" oninput="filtrarInventario(this.value)"/>
        <button class="btn ghost" onclick="exportarInventarioCSV()">Exportar CSV</button>
      </div>
      <div class="grid cols-2">
        <div class="card">
          <h3>Producto</h3>
          <div class="grid">
            <input id="inv-sku" placeholder="SKU*"/>
            <input id="inv-nombre" placeholder="Nombre*"/>
            <input id="inv-categoria" placeholder="Categor√≠a"/>
            <input id="inv-precioVenta" type="number" step="0.01" placeholder="Precio venta*"/>
            <label>IVA (opcional)
              <select id="inv-iva">
                <option value="" selected>‚Äî</option><option value="16">16%</option><option value="8">8%</option><option value="0">0%</option>
              </select>
            </label>
            <input id="inv-stock" type="number" placeholder="Stock*"/>
            <input id="inv-lote" placeholder="Lote"/>
            <input id="inv-cad" type="date" placeholder="Caducidad"/>
            <input id="inv-index" type="hidden"/>
            <div class="toolbar">
              <button class="btn" onclick="guardarProducto()">Guardar</button>
              <button class="btn ghost" onclick="limpiarProducto()">Limpiar</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Listado</h3>
          <table id="tabla-inv"><thead><tr><th>SKU</th><th>Producto</th><th>Stock</th><th>Precio</th><th>Lote</th><th>Caducidad</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>

  <!-- CLIENTES -->
  <section id="view-clientes" class="view">
    <div class="card">
      <h2>Clientes</h2>
      <div class="toolbar">
        <input placeholder="Buscar cliente‚Ä¶" oninput="filtrarClientes(this.value)"/>
        <button class="btn ghost" onclick="exportarClientesCSV()">Exportar CSV</button>
      </div>
      <div class="grid cols-2">
        <div class="card">
          <h3>Alta / edici√≥n</h3>
          <div class="grid">
            <input id="cli-nombre" placeholder="Nombre*"/>
            <input id="cli-tel" placeholder="Tel√©fono"/>
            <input id="cli-correo" placeholder="Correo"/>
            <input id="cli-rfc" placeholder="RFC"/>
            <input id="cli-index" type="hidden"/>
            <div class="toolbar">
              <button class="btn" onclick="guardarCliente()">Guardar</button>
              <button class="btn ghost" onclick="limpiarCliente()">Limpiar</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Listado</h3>
          <table id="tabla-cli"><thead><tr><th>Nombre</th><th>Tel√©fono</th><th>Correo</th><th>Compras</th><th></th></tr></thead><tbody></tbody></table>
        </div>
      </div>
    </div>
  </section>

  <!-- RECETAS -->
  <section id="view-recetas" class="view">
    <div class="card">
      <h2>Recetas (control farmacia)</h2>
      <div class="toolbar">
        <select id="rx-cliente"></select>
        <input type="file" id="rx-archivo"/>
        <select id="rx-estatus">
          <option>Pendiente</option><option>Validada</option><option>Expirada</option>
        </select>
        <button class="btn" onclick="guardarReceta()">Guardar receta</button>
        <button class="btn ghost" onclick="exportarRecetasCSV()">Exportar CSV</button>
      </div>
      <div class="toolbar">
        <input id="rx-buscar" placeholder="Buscar por cliente/archivo‚Ä¶" oninput="pintarRecetas()"/>
        <select id="rx-filtro" onchange="pintarRecetas()"><option value="">Todos</option><option>Pendiente</option><option>Validada</option><option>Expirada</option></select>
      </div>
      <table id="tabla-rec"><thead><tr><th>Fecha</th><th>Cliente</th><th>Archivo</th><th>Estatus</th><th></th></tr></thead><tbody></tbody></table>
      <p class="muted">Archivos guardados localmente (IndexedDB). Desc√°rgalos cuando quieras.</p>
    </div>
  </section>

  <!-- REPORTES -->
  <section id="view-reportes" class="view">
    <div class="card">
      <h2>Reportes</h2>
      <div class="toolbar">
        <select id="rep-rango">
          <option value="hoy">Hoy</option>
          <option value="7">√öltimos 7 d√≠as</option>
          <option value="30">√öltimos 30 d√≠as</option>
          <option value="mes">Mes actual</option>
        </select>
        <button class="btn" onclick="generarReportes()">Generar</button>
        <button class="btn ghost" onclick="exportarVentasCSV()">Exportar ventas CSV</button>
        <button class="btn" onclick="imprimirResumen()">Imprimir/Guardar PDF</button>
      </div>
      <div id="rep-cards" class="grid cols-2"></div>
      <div class="card" style="margin-top:10px">
        <h3>Ventas (detalle)</h3>
        <table id="tabla-ventas"><thead><tr><th>Folio</th><th>Fecha</th><th>Pago</th><th>Subtotal</th><th>IVA</th><th>Descuento</th><th>Total</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <!-- CONFIG -->
  <section id="view-config" class="view">
    <div class="card">
      <h2>Configuraci√≥n</h2>
      <div class="grid cols-2">
        <div class="card">
          <h3>Negocio</h3>
          <label>Nombre del negocio<br><input id="negocio" placeholder="Farmacia Demo"/></label>
          <div class="toolbar"><button class="btn" onclick="guardarConfig()">Guardar</button><span class="muted">Se guarda en este dispositivo.</span></div>
        </div>
        <div class="card">
          <h3>Ticket</h3>
          <label>Mensaje al pie<br><input id="pie" placeholder="Gracias por su compra üíä"/></label>
        </div>
        <div class="card">
          <h3>Mantenimiento</h3>
          <p class="muted">Borra datos locales (inventario/ventas/recetas/clientes).</p>
          <button class="btn ghost" onclick="limpiarDatosDemo()">Borrar datos del dispositivo (demo)</button>
        </div>
      </div>
    </div>
  </section>
</main>

<section id="view-ia" class="view" style="padding:16px;display:none">
  <div class="wrap"><div class="card">
    <h2>Consulta IA</h2>
    <textarea id="ia-q" rows="6" placeholder="Escribe tu consulta‚Ä¶"></textarea>
    <div class="toolbar"><button class="btn" onclick="consultaIA()">Consultar</button></div>
    <div id="ia-respuesta" class="card" style="white-space:pre-wrap"></div>
  </div></div>
</section>

<script>
// ===== Helpers =====
function downloadCSV(filename, rows){
  const csv = rows.map(r=>r.map(v=>String(v??'').replace(/"/g,'""')).map(v=>`"${v}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}
function formatea(n){ return '$'+(+n).toFixed(2); }

// ===== Datos persistentes =====
const STORE_KEY='tpv_farma_export_v1';
const defaultData={
  inventario:[
    {sku:'PARA-500', nombre:'Paracetamol 500mg 10 tabs', precioVenta:45, iva:'', stock:120, lote:'L12345', cad:'2026-05-10'},
    {sku:'IBU-400', nombre:'Ibuprofeno 400mg 20 tabs', precioVenta:80, iva:'16', stock:85, lote:'I45678', cad:'2026-01-20'},
    {sku:'VITA-C1G', nombre:'Vitamina C 1g 100 tabs', precioVenta:150, iva:'', stock:40, lote:'V78901', cad:'2027-03-15'},
    {sku:'SUERO-500', nombre:'Suero oral 500ml', precioVenta:35, iva:'16', stock:100, lote:'S99001', cad:'2025-12-10'}
  ],
  clientes:[{nombre:'Juan P√©rez',tel:'555-100-2000',correo:'',rfc:'',compras:0},{nombre:'Mar√≠a L√≥pez',tel:'',correo:'',rfc:'',compras:0}],
  ventas:[],
  recetas:[]
};
let db = JSON.parse(localStorage.getItem(STORE_KEY)||'null')||defaultData;
function save(){ localStorage.setItem(STORE_KEY, JSON.stringify(db)); }

// ===== Men√∫ =====
const AREAS=[
  {id:'ventas',nombre:'Ventas'},{id:'inventario',nombre:'Inventario'},
  {id:'clientes',nombre:'Clientes'},{id:'recetas',nombre:'Recetas'},
  {id:'reportes',nombre:'Reportes'},{id:'config',nombre:'Configuraci√≥n'}
];
const menu=document.getElementById('menu');
AREAS.forEach(a=>{ const b=document.createElement('button'); b.className='navbtn'; b.innerHTML='<b>'+a.nombre+'</b><div class="muted">Abrir</div>'; b.onclick=()=>goto(a.id); menu.appendChild(b); });
function mostrar(id){ document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); const sec=document.getElementById('view-'+id); if(sec){ sec.classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); }}

// ===== Ventas =====
let carrito=[];
function sugerenciasHTML(list){ return list.map(p=>`<div style='padding:6px 8px;border-bottom:1px solid #eef3f2;cursor:pointer' onclick='agregarProductoPorSKU("${p.sku}")'><b>${p.nombre}</b><br><span class="muted">${p.sku} ¬∑ $${(+p.precioVenta||0).toFixed(2)} ¬∑ Stock: ${p.stock||0}</span></div>`).join(''); }
function buscarYAgregar(){ const q=(document.getElementById('buscar').value||'').trim().toLowerCase(); if(!q) return; const inv=db.inventario||[]; let list=inv.filter(p=>(p.sku||'').toLowerCase()===q); if(list.length===0){ list=inv.filter(p=>(p.nombre||'').toLowerCase().includes(q)); const sug=document.getElementById('sugerencias'); if(list.length>1){ sug.innerHTML=sugerenciasHTML(list.slice(0,20)); sug.style.display='block'; return; } } const p=list[0]; if(!p){ alert('No encontrado'); return;} document.getElementById('sugerencias').style.display='none'; agregarLinea(p); document.getElementById('buscar').value=''; }
function agregarProductoPorSKU(sku){ const p=(db.inventario||[]).find(x=>x.sku===sku); if(p){ document.getElementById('sugerencias').style.display='none'; agregarLinea(p);} }
function agregarLinea(p){ const precio=+(p.precioVenta||0); const ivaPctRaw=(p.iva===''||p.iva===null||typeof p.iva==='undefined')?null:+p.iva; const existe=carrito.find(i=>i.sku===p.sku); if(existe){ if((existe.cant+1)>(+p.stock||0)){ alert('Sin stock'); return;} existe.cant++; renderCarrito(); return; } carrito.push({sku:p.sku,nombre:p.nombre,cant:1,precio,ivaPct:ivaPctRaw,stock:+(p.stock||0)}); renderCarrito(); }
function cambiarCant(i,delta){ const it=carrito[i]; if(!it) return; const nueva=it.cant+delta; if(nueva<=0){ carrito.splice(i,1);} else if(nueva>it.stock){ alert('Stock insuficiente'); } else { it.cant=nueva; } renderCarrito(); }
function quitarItem(i){ carrito.splice(i,1); renderCarrito(); }
function renderCarrito(){ const tb=document.querySelector('#tabla-carrito tbody'); tb.innerHTML=''; let subtotal=0, impuestos=0; carrito.forEach((it,i)=>{ const base=it.cant*it.precio; const iva=(it.ivaPct==null?0:base*(it.ivaPct/100)); subtotal+=base; impuestos+=iva; const ivaTxt=(it.ivaPct==null?'‚Äî':(it.ivaPct||0)+'%'); const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.sku}</td><td>${it.nombre}</td><td><button class='btn ghost' onclick='cambiarCant(${i},-1)'>-</button> ${it.cant} <button class='btn ghost' onclick='cambiarCant(${i},1)'>+</button></td><td>${formatea(it.precio)}</td><td>${ivaTxt}</td><td>${formatea(base+iva)}</td><td><button class='btn ghost' onclick='quitarItem(${i})'>Quitar</button></td>`; tb.appendChild(tr); }); const pctEl=document.getElementById('descuento'); const pct=(pctEl && pctEl.value!=='' ? Math.max(0,Math.min(100,+pctEl.value)) : null); const preTotal=subtotal+impuestos; const descAmt=pct==null?0:(preTotal*(pct/100)); const total=preTotal-descAmt; document.getElementById('subtotal').textContent=`Subtotal: ${formatea(subtotal)}`; document.getElementById('impuestos').textContent=`Impuestos: ${formatea(impuestos)}`; const dbadge=document.getElementById('descuentoBadge'); if(pct==null||descAmt<=0){ dbadge.style.display='none'; } else { dbadge.style.display='inline-grid'; dbadge.textContent=`Descuento (${pct.toFixed(1)}%): -${formatea(descAmt)}`; } document.getElementById('total').textContent=`Total: ${formatea(total)}`; }
function siguienteFolio(){ const f= +(localStorage.getItem('folio')||1); localStorage.setItem('folio', f+1); const s=String(f).padStart(4,'0'); const el=document.getElementById('folio-num'); if(el) el.textContent=s; return s; }
function cargarFolio(){ const f= +(localStorage.getItem('folio')||1); const s=String(f).padStart(4,'0'); const el=document.getElementById('folio-num'); if(el) el.textContent=s; }
function cobrar(){ if(carrito.length===0){ alert('Carrito vac√≠o'); return; } for(const it of carrito){ const prod=(db.inventario||[]).find(p=>p.sku===it.sku); if(!prod || (+prod.stock<it.cant)){ alert('Stock insuficiente de '+(it.nombre||it.sku)); return; } } let subtotal=0, impuestos=0; carrito.forEach(it=>{ const base=it.cant*it.precio; const iva=(it.ivaPct==null?0:base*(it.ivaPct/100)); subtotal+=base; impuestos+=iva; }); const pctEl=document.getElementById('descuento'); const pct=(pctEl && pctEl.value!=='' ? Math.max(0,Math.min(100,+pctEl.value)) : null); const preTotal=subtotal+impuestos; const descAmt=pct==null?0:(preTotal*(pct/100)); const totalNum=preTotal-descAmt; carrito.forEach(it=>{ const prod=db.inventario.find(p=>p.sku===it.sku); prod.stock=(+prod.stock||0)-it.cant; }); save(); pintarInv(); db.ventas=db.ventas||[]; const folio=siguienteFolio(); const ticket={ folio, fecha:new Date().toISOString(), pago:document.getElementById('pago').value, descuentoPct:pct, descuentoAmt:descAmt, subtotal, impuestos, total: totalNum, items:carrito.map(i=>({sku:i.sku,nombre:i.nombre,cant:i.cant,precio:i.precio,iva:i.ivaPct})) }; db.ventas.push(ticket); save(); imprimirTicket(ticket); carrito=[]; renderCarrito(); alert('Cobro registrado'); }
function imprimirTicket(t){ const negocio=localStorage.getItem('negocio')||'Farma Demo'; const pie=localStorage.getItem('pieTicket')||'Gracias por su compra üíä'; const win=window.open('','ticket','width=380,height=600'); win.document.write(`<html><head><title>Ticket ${t.folio}</title><style>body{font-family:system-ui;padding:10px} h3{margin:0 0 6px 0} table{width:100%;font-size:12px;border-collapse:collapse} td{padding:4px 0;border-bottom:1px dashed #ccc}</style></head><body>`); win.document.write(`<h3>${negocio}</h3><div>Folio: ${t.folio} | ${new Date(t.fecha).toLocaleString()}</div><hr><table>`); t.items.forEach(i=>{ const base=(i.cant*i.precio); const ivaLine=(i.iva==null?0:(base*(i.iva/100))); const imp=base+ivaLine; const ivaBadge=(i.iva==null?'':` <span style='color:#0a4e49'>(IVA ${i.iva}%)</span>`); win.document.write(`<tr><td>${i.nombre} x${i.cant}${ivaBadge}</td><td style='text-align:right'>${formatea(imp)}</td></tr>`); }); win.document.write(`</table><hr>`); win.document.write(`<div style='text-align:right'>Subtotal: ${formatea(t.subtotal)}</div>`); win.document.write(`<div style='text-align:right'>Impuestos: ${formatea(t.impuestos)}</div>`); if(t.descuentoPct!=null && t.descuentoAmt>0){ win.document.write(`<div style='text-align:right'>Descuento (${t.descuentoPct.toFixed(1)}%): -${formatea(t.descuentoAmt)}</div>`); } win.document.write(`<div style='text-align:right;font-weight:700'>Total: ${formatea(t.total)}</div>`); if(t.items.some(i=>i.iva!=null)){ win.document.write(`<p style='font-size:11px;margin-top:6px;color:#374151'>Incluye IVA por producto solo cuando est√° especificado.</p>`);} win.document.write(`<p style='margin-top:10px;text-align:center'>${pie}</p></body></html>`); win.document.close(); win.print(); }

// ===== Inventario CRUD + export =====
function getInvForm(){ return { sku:document.getElementById('inv-sku').value.trim(), nombre:document.getElementById('inv-nombre').value.trim(), categoria:document.getElementById('inv-categoria').value.trim(), precioVenta:+(document.getElementById('inv-precioVenta').value||0), iva:(document.getElementById('inv-iva').value===''? '': document.getElementById('inv-iva').value), stock:+(document.getElementById('inv-stock').value||0), lote:document.getElementById('inv-lote').value.trim(), cad:document.getElementById('inv-cad').value }; }
function setInvForm(p){ document.getElementById('inv-sku').value=p.sku||''; document.getElementById('inv-nombre').value=p.nombre||''; document.getElementById('inv-categoria').value=p.categoria||''; document.getElementById('inv-precioVenta').value=p.precioVenta||''; document.getElementById('inv-iva').value=(p.iva===''?'':p.iva)||''; document.getElementById('inv-stock').value=p.stock||''; document.getElementById('inv-lote').value=p.lote||''; document.getElementById('inv-cad').value=p.cad||''; }
function limpiarProducto(){ setInvForm({}); document.getElementById('inv-index').value=''; }
function guardarProducto(){ const idx=(document.getElementById('inv-index').value||''); const p=getInvForm(); if(!p.sku||!p.nombre||!p.precioVenta){ alert('SKU, Nombre y Precio venta son obligatorios'); return; } if(idx===''){ db.inventario.push(p);} else { db.inventario[+idx]=p;} save(); limpiarProducto(); pintarInv(); }
function editarProducto(i){ document.getElementById('inv-index').value=i; setInvForm(db.inventario[i]); }
function eliminarProducto(i){ if(confirm('¬øEliminar producto?')){ db.inventario.splice(i,1); save(); pintarInv(); } }
function pintarInv(list){ list=list||db.inventario; const tb=document.querySelector('#tabla-inv tbody'); if(!tb) return; tb.innerHTML=''; list.forEach((p,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${p.sku}</td><td>${p.nombre}</td><td>${p.stock}</td><td>${formatea(+p.precioVenta)}</td><td>${p.lote||''}</td><td>${p.cad||''}</td><td><button class='btn ghost' onclick='editarProducto(${i})'>Editar</button> <button class='btn' onclick='eliminarProducto(${i})'>Eliminar</button></td>`; tb.appendChild(tr); }); }
function filtrarInventario(q){ const v=(q||'').toLowerCase(); pintarInv(db.inventario.filter(p=>Object.values(p).join(' ').toLowerCase().includes(v))); }
function exportarInventarioCSV(){ const rows=[['SKU','Nombre','Categor√≠a','PrecioVenta','IVA','Stock','Lote','Caducidad'],...db.inventario.map(p=>[p.sku,p.nombre,p.categoria||'',p.precioVenta,p.iva,p.stock,p.lote||'',p.cad||''])]; downloadCSV('inventario.csv',rows); }

// ===== Clientes CRUD + export =====
function getCliForm(){ return { nombre:document.getElementById('cli-nombre').value.trim(), tel:document.getElementById('cli-tel').value.trim(), correo:document.getElementById('cli-correo').value.trim(), rfc:document.getElementById('cli-rfc').value.trim(), compras:0 }; }
function setCliForm(c){ document.getElementById('cli-nombre').value=c.nombre||''; document.getElementById('cli-tel').value=c.tel||''; document.getElementById('cli-correo').value=c.correo||''; document.getElementById('cli-rfc').value=c.rfc||''; }
function limpiarCliente(){ setCliForm({}); document.getElementById('cli-index').value=''; }
function guardarCliente(){ const idx=document.getElementById('cli-index').value||''; const c=getCliForm(); if(!c.nombre){alert('Nombre es obligatorio'); return;} if(idx===''){ db.clientes.push(c);} else { db.clientes[+idx]=c;} save(); limpiarCliente(); pintarClientes(); cargarClientesSelects(); }
function editarCliente(i){ document.getElementById('cli-index').value=i; setCliForm(db.clientes[i]); }
function eliminarCliente(i){ if(confirm('¬øEliminar cliente?')){ db.clientes.splice(i,1); save(); pintarClientes(); cargarClientesSelects(); } }
function pintarClientes(list){ list=list||db.clientes; const tb=document.querySelector('#tabla-cli tbody'); if(!tb) return; tb.innerHTML=''; list.forEach((c,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${c.nombre}</td><td>${c.tel||''}</td><td>${c.correo||''}</td><td>${c.compras||0}</td><td><button class='btn ghost' onclick='editarCliente(${i})'>Editar</button> <button class='btn' onclick='eliminarCliente(${i})'>Eliminar</button></td>`; tb.appendChild(tr); }); }
function filtrarClientes(q){ const v=(q||'').toLowerCase(); pintarClientes(db.clientes.filter(c=>Object.values(c).join(' ').toLowerCase().includes(v))); }
function exportarClientesCSV(){ const rows=[['Nombre','Telefono','Correo','RFC','Compras'],...db.clientes.map(c=>[c.nombre,c.tel||'',c.correo||'',c.rfc||'',c.compras||0])]; downloadCSV('clientes.csv',rows); }
function cargarClientesSelects(){ const sel=document.getElementById('rx-cliente'); if(sel){ sel.innerHTML=''; (db.clientes||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c.nombre; o.textContent=c.nombre; sel.appendChild(o); }); } }

// ===== Recetas (IndexedDB) + export =====
let rxDB=null;
function openRxDB(){ return new Promise((resolve,reject)=>{ const req=indexedDB.open('tpv_rx_files',1); req.onupgradeneeded=e=>{ const db=e.target.result; if(!db.objectStoreNames.contains('rx')){ const s=db.createObjectStore('rx',{keyPath:'id',autoIncrement:true}); s.createIndex('cliente','cliente',{unique:false}); } }; req.onsuccess=()=>{rxDB=req.result; resolve(rxDB);} ; req.onerror=()=>reject(req.error); }); }
function addRx(rec){ return new Promise((resolve,reject)=>{ const tx=rxDB.transaction('rx','readwrite'); const s=tx.objectStore('rx'); const r=s.add(rec); r.onsuccess=()=>resolve(r.result); r.onerror=()=>reject(r.error); }); }
function getRx(){ return new Promise((resolve,reject)=>{ const tx=rxDB.transaction('rx','readonly'); const s=tx.objectStore('rx'); const r=s.getAll(); r.onsuccess=()=>resolve(r.result||[]); r.onerror=()=>reject(r.error); }); }
async function guardarReceta(){ try{ await openRxDB(); const cliente=(document.getElementById('rx-cliente').value||''); if(!cliente){ alert('Selecciona cliente'); return; } const estatus=document.getElementById('rx-estatus').value; const fileEl=document.getElementById('rx-archivo'); const f=fileEl.files[0]; let blob=null,name=''; if(f){ const buf=await f.arrayBuffer(); blob=new Blob([buf],{type:f.type||'application/octet-stream'}); name=f.name; } const rec={cliente, estatus, fecha:new Date().toISOString(), name, blob}; await addRx(rec); fileEl.value=''; await pintarRecetas(); alert('Receta guardada'); } catch(e){ alert('Error: '+e); } }
async function pintarRecetas(){ await openRxDB(); const filtro=document.getElementById('rx-filtro')?.value||''; const q=(document.getElementById('rx-buscar')?.value||'').toLowerCase(); const list=(await getRx()).filter(r=>(!filtro||r.estatus===filtro) && (`${r.cliente} ${r.name}`.toLowerCase().includes(q))); const tb=document.querySelector('#tabla-rec tbody'); if(!tb) return; tb.innerHTML=''; list.sort((a,b)=>b.fecha.localeCompare(a.fecha)); list.forEach(r=>{ const tr=document.createElement('tr'); const d=new Date(r.fecha).toLocaleString(); tr.innerHTML=`<td>${d}</td><td>${r.cliente}</td><td>${r.name||'‚Äî'}</td><td>${r.estatus}</td><td><button class='btn ghost' onclick='descargarRx(${r.id})'>Descargar</button></td>`; tb.appendChild(tr); }); }
async function descargarRx(id){ await openRxDB(); const tx=rxDB.transaction('rx','readonly'); const s=tx.objectStore('rx'); const r=s.get(id); r.onsuccess=()=>{ const rec=r.result; if(!rec||!rec.blob){ alert('No hay archivo'); return;} const url=URL.createObjectURL(rec.blob); const a=document.createElement('a'); a.href=url; a.download=rec.name||'receta'; a.click(); URL.revokeObjectURL(url); }; }
async function exportarRecetasCSV(){ await openRxDB(); const list=await getRx(); const rows=[['ID','Fecha','Cliente','Archivo','Estatus'], ...list.map(r=>[r.id,new Date(r.fecha).toLocaleString(),r.cliente,r.name||'',r.estatus])]; downloadCSV('recetas.csv',rows); }

// ===== Reportes + export =====
function generarReportes(){ const rango=document.getElementById('rep-rango').value; const now=new Date(); let from=new Date(); if(rango==='hoy'){ from = new Date(now.getFullYear(),now.getMonth(),now.getDate()); } else if(rango==='7'){ from = new Date(now.getTime()-7*86400000); } else if(rango==='30'){ from = new Date(now.getTime()-30*86400000); } else if(rango==='mes'){ from = new Date(now.getFullYear(),now.getMonth(),1); } const ventas=db.ventas.filter(v=> new Date(v.fecha) >= from ); const cards=document.getElementById('rep-cards'); cards.innerHTML=''; const total=ventas.reduce((a,v)=>a+Number(v.total||0),0); const iva=ventas.reduce((a,v)=>a+Number(v.impuestos||0),0); const desc=ventas.reduce((a,v)=>a+Number(v.descuentoAmt||0),0); const tickets=ventas.length; const top=(()=>{ const m=new Map(); ventas.forEach(v=>v.items.forEach(i=>m.set(i.nombre,(m.get(i.nombre)||0)+i.cant))); let r=[...m.entries()].sort((a,b)=>b[1]-a[1])[0]; return r? r[0]+' ('+r[1]+')':'‚Äî'; })(); const mk=(t,v)=>{ const c=document.createElement('div'); c.className='card'; c.innerHTML=`<h3>${t}</h3><p style="font-size:26px;font-weight:800">${v}</p>`; return c; }; cards.append(mk('Total vendido', formatea(total))); cards.append(mk('IVA acumulado', formatea(iva))); cards.append(mk('Descuentos', formatea(desc))); cards.append(mk('Tickets', tickets)); cards.append(mk('Top producto', top)); const tb=document.querySelector('#tabla-ventas tbody'); tb.innerHTML=''; ventas.forEach(v=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${v.folio}</td><td>${new Date(v.fecha).toLocaleString()}</td><td>${v.pago}</td><td>${formatea(v.subtotal)}</td><td>${formatea(v.impuestos)}</td><td>${v.descuentoAmt?formatea(v.descuentoAmt):'‚Äî'}</td><td>${formatea(v.total)}</td>`; tb.appendChild(tr); }); }
function exportarVentasCSV(){ const rows=[['Folio','Fecha','Pago','Subtotal','IVA','Descuento','Total'], ...(db.ventas||[]).map(v=>[v.folio,new Date(v.fecha).toLocaleString(),v.pago,Number(v.subtotal||0),Number(v.impuestos||0),Number(v.descuentoAmt||0),Number(v.total||0)])]; downloadCSV('ventas.csv',rows); }
function imprimirResumen(){ const cont=document.getElementById('rep-cards').innerHTML; const table=document.getElementById('tabla-ventas').outerHTML; const w=window.open('','rep','width=900,height=700'); w.document.write(`<html><head><title>Resumen de ventas</title><style>body{font-family:system-ui;padding:16px} h2{margin:0 0 10px 0} table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #ddd;text-align:left} th{font-size:12px;text-transform:uppercase;color:#555}</style></head><body><h2>Resumen de ventas</h2><div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">${cont}</div><h3>Detalle</h3>${table}</body></html>`); w.document.close(); w.print(); }

// ===== IA (placeholder) =====
function openIAWindow(){ const base=location.origin+location.pathname; window.open(base+'#'+'/ia','consulta-ia'); }
function consultaIA(){ const q=(document.getElementById('ia-q').value||'').trim(); const out=document.getElementById('ia-respuesta'); if(!q){ alert('Escribe tu consulta'); return; } out.textContent='Consultando‚Ä¶ (demo)'; setTimeout(()=>{ out.textContent='(Respuesta de ejemplo)'; },600); }

// ===== Config =====
function guardarConfig(){ localStorage.setItem('negocio',document.getElementById('negocio').value); localStorage.setItem('pieTicket',document.getElementById('pie').value); alert('Configuraci√≥n guardada'); }
function cargarConfig(){ document.getElementById('negocio').value=localStorage.getItem('negocio')||''; document.getElementById('pie').value=localStorage.getItem('pieTicket')||'Gracias por su compra üíä'; }
async function limpiarDatosDemo(){ if(!confirm('Esto borrar√° inventario, ventas, config y recetas/archivos locales. ¬øContinuar?')) return; localStorage.removeItem(STORE_KEY); localStorage.removeItem('folio'); if(window.indexedDB){ await new Promise(res=>{ const a=indexedDB.deleteDatabase('tpv_rx_files'); a.onsuccess=a.onerror=a.onblocked=()=>res(); }); } alert('Datos borrados. Recargando‚Ä¶'); location.reload(); }

// ===== Routing & Init =====
function goto(id){ location.hash = '#/'+id; }
function route(){ const id=(location.hash.replace('#/','')||'ventas'); document.getElementById('view-ia').style.display=(id==='ia')?'block':'none'; mostrar(id); if(id==='reportes') generarReportes(); if(id==='recetas') { cargarClientesSelects(); pintarRecetas(); } if(id==='clientes') { pintarClientes(); } }
window.addEventListener('hashchange',route);

function init(){ pintarInv(); cargarConfig(); cargarFolio(); initAtajos(); cargarClientesSelects(); route(); }
function initAtajos(){ const cont=document.getElementById('atajos'); if(!cont) return; cont.innerHTML=''; (db.inventario||[]).slice(0,9).forEach(p=>{ const b=document.createElement('button'); b.className='btn ghost'; b.textContent=(p.nombre||'').split(' ').slice(0,2).join(' '); b.title=p.nombre; b.onclick=()=>agregarLinea(p); cont.appendChild(b); }); }

init();
</script>
</body>
</html>
